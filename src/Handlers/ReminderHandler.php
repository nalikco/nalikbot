<?php
namespace Klassnoenazvanie\Handlers;

use Klassnoenazvanie\Helpers\Dates;
use Klassnoenazvanie\Helpers\Keyboards;

class ReminderHandler {
    private $vk;
    private $access_token;
    private $entityManager;

    public function __construct($vk, $access_token, $entityManager) {
        $this->vk = $vk;
        $this->access_token = $access_token;
        $this->entityManager = $entityManager;
    }

    public function initiate($user, int $conversation_message_id) {
        $this->vk->messages()->edit($this->access_token, [
            'peer_id' => $user->getVkId(),
            'message' => '–ú–µ–Ω—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π',
            'conversation_message_id' => $conversation_message_id,
            'keyboard' => Keyboards::getReminderMainMenu()
        ]);
    }

    public function runStep($object, $user) {
        switch($user->getStep()){
            case 0:
                if($object['message']['text'] == '–û—Ç–º–µ–Ω–∞') {
                    $user->setApp(0);
                    $user->setStep(0);

                    $this->entityManager->persist($user);
                    $this->entityManager->flush();

                    return $this->vk->messages()->send($this->access_token, [
                        'user_id' => $user->getVkId(),
                        'random_id' => rand(5, 2147483647),
                        'message' => '‚ùé –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ',
                        'keyboard' => Keyboards::getMain()
                    ]);
                }

                $wrong_date_message = "‚è∫ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n–î–∞—Ç–∞ (–¥–¥-–º–º-–≥–≥–≥–≥ –ß–ß:–ú–ú)\n–¢–µ–∫—Å—Ç";

                $matches = [];
                preg_match('~^(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})\n(.*)$~', $object['message']['text'], $matches);

                if($matches){
                    $year = intval($matches[3]);
                    $month = intval($matches[2]);
                    $day = intval($matches[1]);
                    $hour = intval($matches[4]);
                    $minute = intval($matches[5]);
                    $text = $matches[6];

                    if (!checkdate($month, $day, $year)) {
                        $this->vk->messages()->send($this->access_token, [
                            'user_id' => $user->getVkId(),
                            'random_id' => rand(5, 2147483647),
                            'message' => $wrong_date_message,
                            'keyboard' => Keyboards::getWithCancel()
                        ]);
                    }

                    if($hour > 24 || $hour < 0 || $minute > 60 || $minute < 0) {
                        $this->vk->messages()->send($this->access_token, [
                            'user_id' => $user->getVkId(),
                            'random_id' => rand(5, 2147483647),
                            'message' => $wrong_date_message,
                            'keyboard' => Keyboards::getWithCancel()
                        ]);
                    }

                    $date_string = sprintf("%'.04d-%'.02d-%'.02d %'.02d:%'.02d", $year, $month, $day, $hour, $minute);
                    $date = strtotime($date_string);
                    $now = time();
                    $datediff = $now - $date;

                    if ($datediff >= 0) {
                        $this->vk->messages()->send($this->access_token, [
                            'user_id' => $user->getVkId(),
                            'random_id' => rand(5, 2147483647),
                            'message' => $wrong_date_message,
                            'keyboard' => Keyboards::getWithCancel()
                        ]);
                    }

                    $reminder = new \Klassnoenazvanie\Reminder();
                    $reminder->setDate(new \DateTime($date_string));
                    $reminder->setText($text);
                    $reminder->setDone(0);

                    $user->setApp(0);
                    $user->setStep(0);
                    $reminder->setUser($user);
                    $user->getReminders()->add($reminder);

                    $this->entityManager->persist($reminder);
                    $this->entityManager->persist($user);
                    $this->entityManager->flush();

                    $this->vk->messages()->send($this->access_token, [
                        'user_id' => $user->getVkId(),
                        'random_id' => rand(5, 2147483647),
                        'message' => sprintf("‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ.\n\n–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: %s\n–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: %s", Dates::formatDate($reminder->getDate()), $text),
                        'keyboard' => Keyboards::getMain()
                    ]);

                    if ($user->getVkId() == getenv('IGOR_ID')) {
                        $secondUser = getenv('OKSY_ID');
                        $infoMessage = "@id".getenv('IGOR_ID')." (–ò–≥–æ—Ä—å) —Å–æ–∑–¥–∞–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ";
                    } else {
                        $secondUser = getenv('IGOR_ID');
                        $infoMessage = "@id".getenv('OKSY_ID')." (–û–∫—Å–∞–Ω–∞) —Å–æ–∑–¥–∞–ª–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ";
                    }

                    $this->vk->messages()->send($this->access_token, [
                        'user_id' => $secondUser,
                        'random_id' => rand(5, 2147483647),
                        'message' => sprintf("%s.\n\n–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: %s\n–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: %s", $infoMessage, Dates::formatDate($reminder->getDate()), $text),
                    ]);
                } else {
                    $this->vk->messages()->send($this->access_token, [
                        'user_id' => $user->getVkId(),
                        'random_id' => rand(5, 2147483647),
                        'message' => $wrong_date_message,
                        'keyboard' => Keyboards::getWithCancel()
                    ]);
                }
                break;
            case 2:
                if($object['message']['text'] == '–û—Ç–º–µ–Ω–∞') {
                    $user->setApp(0);
                    $user->setStep(0);

                    $this->entityManager->persist($user);
                    $this->entityManager->flush();

                    $this->vk->messages()->send($this->access_token, [
                        'user_id' => $user->getVkId(),
                        'random_id' => rand(5, 2147483647),
                        'message' => '‚ùé –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ',
                        'keyboard' => Keyboards::getMain()
                    ]);

                    return;
                }

                $reminder_id = intval($object['message']['text']);

                if ($reminder_id == 0) return $this->vk->messages()->send($this->access_token, [
                    'user_id' => $user->getVkId(),
                    'random_id' => rand(5, 2147483647),
                    'message' => '‚ùé –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è',
                    'keyboard' => Keyboards::getWithCancel()
                ]);

                $reminder = $this->entityManager->getRepository('Klassnoenazvanie\Reminder')->findOneBy(['id' => $reminder_id, 'done' => 0]);

                if (!$reminder) return $this->vk->messages()->send($this->access_token, [
                    'user_id' => $user->getVkId(),
                    'random_id' => rand(5, 2147483647),
                    'message' => '‚ùé –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å —Ç–∞–∫–∏–º ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
                    'keyboard' => Keyboards::getWithCancel()
                ]);

                $reminder->setDone(1);
                $user->setApp(0);
                $user->setStep(0);

                $this->entityManager->persist($user);
                $this->entityManager->persist($reminder);
                $this->entityManager->flush();

                return $this->vk->messages()->send($this->access_token, [
                    'user_id' => $user->getVkId(),
                    'random_id' => rand(5, 2147483647),
                    'message' => 'üóë –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ',
                    'keyboard' => Keyboards::getMain()
                ]);

                break;
        }
    }

    public function listActive($user, int $conversation_message_id): void
    {
        $message = "–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:\n\n";

        $activeReminders = $this->entityManager->getRepository('Klassnoenazvanie\Reminder')->findBy(['done' => 0]);

        foreach($activeReminders as $reminder) {
            $now = time();
            $datediff = $now - $reminder->getDate()->getTimestamp();

            if ($datediff < 0){
                $userInfo = $this->vk->users()->get($this->access_token, ['user_id' => $reminder->getUser()->getVkId()])[0];
                $message = $message."\n‚Äî ".Dates::formatDate($reminder->getDate()).":\n–¢–µ–∫—Å—Ç: ".$reminder->getText()."\n@id".$userInfo['id']." (".$userInfo['first_name']."), ID ".$reminder->getId()." (—á–µ—Ä–µ–∑ ".Dates::countdown($datediff).")\n";
            }
        }

        $this->vk->messages()->edit($this->access_token, [
            'peer_id' => $user->getVkId(),
            'message' => $message,
            'conversation_message_id' => $conversation_message_id,
        ]);
    }

    public function initiateCreating($user, int $conversation_message_id): void
    {
        $user->setApp(1);
        $user->setStep(0);

        $this->entityManager->persist($user);
        $this->entityManager->flush();

        $this->vk->messages()->edit($this->access_token, [
            'peer_id' => $user->getVkId(),
            'message' => "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n–î–∞—Ç–∞ (–¥–¥-–º–º-–≥–≥–≥–≥ –ß–ß:–ú–ú)\n–¢–µ–∫—Å—Ç",
            'conversation_message_id' => $conversation_message_id,
            'keyboard' => Keyboards::getWithCancel()
        ]);
    }

    public function initiateDeleting($user, int $conversation_message_id): void
    {
        $user->setApp(1);
        $user->setStep(2);

        $this->entityManager->persist($user);
        $this->entityManager->flush();

        $this->vk->messages()->edit($this->access_token, [
            'peer_id' => $user->getVkId(),
            'message' => "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ ID –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
            'conversation_message_id' => $conversation_message_id,
            'keyboard' => Keyboards::getWithCancel()
        ]);
    }
}
